"use strict";(()=>{var e={};e.id=946,e.ids=[946],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4642:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>D,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>u,POST:()=>c});var n=r(9303),o=r(8716),s=r(670),i=r(7070),d=r(3493);async function u(e){try{let{searchParams:t}=new URL(e.url),r=t.get("status"),a=t.get("vanId"),n=await d._.booking.findMany({where:{...r&&{status:r},...a&&{vanId:a}},include:{van:{select:{vanId:!0,registration:!0,make:!0,model:!0}}},orderBy:{startDateTime:"desc"}});return i.NextResponse.json(n)}catch(e){return console.error("Error fetching bookings:",e),i.NextResponse.json({error:"Failed to fetch bookings"},{status:500})}}async function c(e){try{let t=await e.json();for(let e of["projectId","vanId","driverName","driverContact","startDateTime","endDateTime"])if(!t[e])return i.NextResponse.json({error:`Missing required field: ${e}`},{status:400});if(!/^\d{5}$/.test(t.projectId))return i.NextResponse.json({error:"Project ID must be exactly 5 digits"},{status:400});let r=new Date(t.startDateTime),a=new Date(t.endDateTime);if(a<=r)return i.NextResponse.json({error:"End date/time must be after start date/time"},{status:400});let n=await d._.booking.findMany({where:{vanId:t.vanId,status:{in:["REQUESTED","CONFIRMED","ACTIVE"]},OR:[{AND:[{startDateTime:{lte:a}},{endDateTime:{gte:r}}]}]}});if(n.length>0)return i.NextResponse.json({error:"Booking conflict detected",conflicts:n.map(e=>({id:e.id,start:e.startDateTime,end:e.endDateTime,driver:e.driverName}))},{status:409});let o=`BK${Date.now()}`,s=await d._.booking.create({data:{bookingId:o,projectId:t.projectId,vanId:t.vanId,driverName:t.driverName,driverContact:t.driverContact,startDateTime:new Date(t.startDateTime),endDateTime:new Date(t.endDateTime),status:"REQUESTED",createdBy:t.createdBy||"system"},include:{van:!0}});return await d._.auditTrail.create({data:{entityType:"BOOKING",entityId:s.bookingId,action:"CREATE",user:t.createdBy||"system",newValues:JSON.stringify(s)}}),i.NextResponse.json(s,{status:201})}catch(e){return console.error("Error creating booking:",e),i.NextResponse.json({error:"Failed to create booking"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:"app/api/bookings/route"},resolvedPagePath:"/Volumes/Macintosh HD Ext/VBMS/vbms-app/app/api/bookings/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:g}=p,v="/api/bookings/route";function D(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},3493:(e,t,r)=>{r.d(t,{_:()=>n});let a=require("@prisma/client"),n=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(4642));module.exports=a})();