# Van Booking & Fleet Management System - SharePoint Setup Guide

## Overview

This guide provides step-by-step instructions for setting up the SharePoint site and core data structures for the Van Booking & Fleet Management System (VBMS).

## Prerequisites

1. **SharePoint Online** - Access to Microsoft 365 with SharePoint Online
2. **Administrator Access** - Site Collection Administrator or Global Administrator permissions
3. **PnP PowerShell Module** - For automated setup (optional but recommended)

### Installing PnP PowerShell

```powershell
Install-Module -Name PnP.PowerShell -Scope CurrentUser
```

## Setup Options

You can set up the VBMS SharePoint site using either:
- **Option A**: Automated setup using PowerShell script (Recommended)
- **Option B**: Manual setup through SharePoint UI

---

## Option A: Automated Setup (Recommended)

### Step 1: Create SharePoint Site

1. Navigate to SharePoint Admin Center
2. Click **Sites** > **Active sites** > **Create**
3. Select **Team site**
4. Enter site details:
   - **Site name**: Van Booking & Fleet Management System
   - **Site address**: /sites/vbms
   - **Language**: English
   - **Privacy settings**: Private (only members can access)
5. Click **Finish**

### Step 2: Run Setup Script

1. Open PowerShell as Administrator
2. Navigate to the project directory
3. Run the setup script:

```powershell
cd scripts
.\Setup-VBMSSharePointSite.ps1 -SiteUrl "https://yourtenant.sharepoint.com/sites/vbms"
```

4. Authenticate when prompted
5. Wait for the script to complete (approximately 5-10 minutes)

### Step 3: Verify Setup

After the script completes, verify that all lists were created:

1. Navigate to your SharePoint site
2. Click **Site contents**
3. Verify the following lists exist:
   - ✓ Vans
   - ✓ Van Documents
   - ✓ Bookings
   - ✓ Maintenance
   - ✓ Incidents
   - ✓ Costs
   - ✓ Audit_Trail
   - ✓ Error_Log

---

## Option B: Manual Setup

If you prefer to set up manually or the script fails, follow these detailed instructions:

### 1. Create Vans List

1. Go to **Site contents** > **New** > **List**
2. Name: `Vans`
3. Description: `Central registry of all fleet vehicles`
4. Click **Create**

#### Add Columns to Vans List:

| Column Name | Type | Settings |
|------------|------|----------|
| Van_ID | Single line of text | Required, Indexed, Enforce unique values |
| Registration | Single line of text | Required, Indexed, Enforce unique values |
| Make | Single line of text | Required |
| Model | Single line of text | Required |
| Year | Number | Required |
| VIN | Single line of text | Optional |
| Tier | Choice | Required, Choices: Standard, Premium, Specialized |
| Type | Choice | Required, Choices: Cargo, Passenger, Refrigerated |
| Daily_Rate | Currency | Required |
| Mileage_Rate | Currency | Required |
| Status | Choice | Required, Choices: Available, Booked, Active, Unavailable, Inactive, Default: Available |
| Configuration | Multiple lines of text | Optional |
| Accessories | Multiple lines of text | Optional |

#### Enable Versioning:
1. Go to **List settings** > **Versioning settings**
2. Enable **Create a version each time you edit an item**
3. Set **Number of versions to retain**: 50
4. Click **OK**

### 2. Create Van Documents Library

1. Go to **Site contents** > **New** > **Document library**
2. Name: `Van Documents`
3. Click **Create**

#### Add Columns to Van Documents:

| Column Name | Type | Settings |
|------------|------|----------|
| Van_ID | Lookup | Required, Get information from: Vans, In this column: Van_ID |
| Document_Type | Choice | Required, Choices: Insurance, Registration, Inspection |
| Expiry_Date | Date and Time | Required, Date only |

### 3. Create Bookings List

1. Go to **Site contents** > **New** > **List**
2. Name: `Bookings`
3. Description: `Van booking records`
4. Click **Create**

#### Add Columns to Bookings List:

| Column Name | Type | Settings |
|------------|------|----------|
| Booking_ID | Single line of text | Indexed (will be auto-generated by Power Automate) |
| Project_ID | Single line of text | Required, Indexed, Column validation: `=AND(LEN([Project_ID])=5,ISNUMBER(VALUE([Project_ID])))` |
| Van_ID | Lookup | Required, Indexed, Get information from: Vans, In this column: Van_ID |
| Driver_Name | Single line of text | Required |
| Driver_Contact | Single line of text | Required |
| Start_DateTime | Date and Time | Required, Indexed, Date and Time |
| End_DateTime | Date and Time | Required, Indexed, Date and Time |
| Status | Choice | Required, Choices: Requested, Confirmed, Active, Completed, Cancelled, Default: Requested |

#### Enable Versioning:
1. Go to **List settings** > **Versioning settings**
2. Enable **Create a version each time you edit an item**
3. Set **Number of versions to retain**: 50
4. Click **OK**

### 4. Create Maintenance List

1. Go to **Site contents** > **New** > **List**
2. Name: `Maintenance`
3. Description: `Vehicle maintenance records`
4. Click **Create**

#### Add Columns to Maintenance List:

| Column Name | Type | Settings |
|------------|------|----------|
| Maintenance_ID | Single line of text | Indexed (will be auto-generated) |
| Van_ID | Lookup | Required, Get information from: Vans, In this column: Van_ID |
| Scheduled_Date | Date and Time | Required, Date and Time |
| Completed_Date | Date and Time | Optional, Date and Time |
| Description | Multiple lines of text | Required |
| Cost | Currency | Optional |
| Vendor | Single line of text | Optional |
| Maintenance_Type | Choice | Required, Choices: Date-based, Usage-based, Default: Date-based |

#### Enable Attachments:
1. Go to **List settings** > **Advanced settings**
2. Set **Attachments**: Enabled
3. Click **OK**

### 5. Create Incidents List

1. Go to **Site contents** > **New** > **List**
2. Name: `Incidents`
3. Description: `Fines and incident records`
4. Click **Create**

#### Add Columns to Incidents List:

| Column Name | Type | Settings |
|------------|------|----------|
| Incident_ID | Single line of text | Indexed (will be auto-generated) |
| Van_ID | Lookup | Required, Get information from: Vans, In this column: Van_ID |
| Incident_DateTime | Date and Time | Required, Indexed, Date and Time |
| Incident_Type | Choice | Required, Choices: Fine, Accident, Damage, Other |
| Description | Multiple lines of text | Required |
| Amount | Currency | Optional |
| Assigned_Driver | Single line of text | Optional |
| Assigned_Project_ID | Single line of text | Optional |
| Status | Choice | Required, Choices: Open, Assigned, Paid, Resolved, Disputed, Default: Open |

#### Enable Attachments:
1. Go to **List settings** > **Advanced settings**
2. Set **Attachments**: Enabled
3. Click **OK**

### 6. Create Costs List

1. Go to **Site contents** > **New** > **List**
2. Name: `Costs`
3. Description: `Running costs tracking`
4. Click **Create**

#### Add Columns to Costs List:

| Column Name | Type | Settings |
|------------|------|----------|
| Cost_ID | Single line of text | Indexed (will be auto-generated) |
| Van_ID | Lookup | Required, Get information from: Vans, In this column: Van_ID |
| Project_ID | Single line of text | Required, Indexed, Column validation: `=AND(LEN([Project_ID])=5,ISNUMBER(VALUE([Project_ID])))` |
| Driver | Single line of text | Optional |
| Cost_Type | Choice | Required, Choices: Fuel, Tolls, Maintenance, Fine |
| Amount | Currency | Required |
| Date | Date and Time | Required, Date only |
| Description | Multiple lines of text | Optional |
| Source_ID | Single line of text | Optional (links to Maintenance_ID or Incident_ID) |

### 7. Create Audit_Trail List

1. Go to **Site contents** > **New** > **List**
2. Name: `Audit_Trail`
3. Description: `System audit trail`
4. Click **Create**

#### Add Columns to Audit_Trail List:

| Column Name | Type | Settings |
|------------|------|----------|
| Audit_ID | Single line of text | Indexed (will be auto-generated) |
| Entity_Type | Choice | Required, Choices: Van, Booking, Maintenance, Incident, Cost |
| Entity_ID | Single line of text | Required, Indexed |
| Action | Choice | Required, Choices: Create, Update, Delete, Status_Change |
| User | Person or Group | Required |
| Timestamp | Date and Time | Required, Date and Time |
| Changed_Fields | Multiple lines of text | Optional (JSON format) |
| Old_Values | Multiple lines of text | Optional (JSON format) |
| New_Values | Multiple lines of text | Optional (JSON format) |

#### Configure Read-Only Permissions:
1. Go to **List settings** > **Permissions for this list**
2. Click **Stop Inheriting Permissions**
3. Remove **Edit** and **Delete** permissions for all groups except Site Owners
4. Ensure only Power Automate service account has write access

### 8. Create Error_Log List

1. Go to **Site contents** > **New** > **List**
2. Name: `Error_Log`
3. Description: `System error tracking`
4. Click **Create**

#### Add Columns to Error_Log List:

| Column Name | Type | Settings |
|------------|------|----------|
| Error_ID | Single line of text | Indexed (will be auto-generated) |
| Timestamp | Date and Time | Required, Date and Time |
| Component | Choice | Required, Choices: Booking, Maintenance, Incident, Cost, Notification, Calendar |
| Error_Type | Choice | Required, Choices: Validation, Conflict, Authorization, NotFound, System |
| Error_Message | Multiple lines of text | Required |
| Stack_Trace | Multiple lines of text | Optional |
| User | Person or Group | Optional |
| Entity_Type | Single line of text | Optional |
| Entity_ID | Single line of text | Optional |
| Resolved | Yes/No | Default: No |
| Resolution_Notes | Multiple lines of text | Optional |

---

## Post-Setup Configuration

### Configure SharePoint Permissions

#### 1. Create SharePoint Groups

1. Go to **Site settings** > **Site permissions**
2. Click **Create Group**

Create three groups:

**Group 1: VBMS Project Representatives**
- Permissions: Contribute (limited to own items in Bookings list)
- Members: Add all Project Representatives

**Group 2: VBMS Fleet Administrators**
- Permissions: Full Control
- Members: Add all Fleet Administrators

**Group 3: VBMS Finance Managers**
- Permissions: Read
- Members: Add all Finance Managers

#### 2. Configure List-Level Permissions

**Bookings List** (Project Representatives can only edit their own bookings):
1. Go to Bookings list > **List settings** > **Advanced settings**
2. Set **Item-level Permissions**:
   - Read access: Read all items
   - Create and Edit access: Create items and edit items that were created by the user
3. Click **OK**

**Audit_Trail List** (Read-only for all except system):
1. Go to Audit_Trail list > **List settings** > **Permissions for this list**
2. Click **Stop Inheriting Permissions**
3. Remove **Edit** and **Delete** permissions for all groups
4. Grant **View Only** permissions to Fleet Administrators
5. Ensure Power Automate service account has **Contribute** permissions

### Configure Column Validation

Verify that column validation is working:

**Project_ID Validation** (Bookings and Costs lists):
1. Go to list > **List settings** > Click on **Project_ID** column
2. In **Column Validation** section, enter:
   - Formula: `=AND(LEN([Project_ID])=5,ISNUMBER(VALUE([Project_ID])))`
   - User message: `Project ID must be exactly 5 digits`
3. Click **OK**

### Test Data Structure

Create test records to verify the setup:

1. **Create a test van**:
   - Van_ID: V001
   - Registration: TEST123
   - Make: Ford
   - Model: Transit
   - Year: 2023
   - Tier: Standard
   - Type: Cargo
   - Daily_Rate: $100
   - Mileage_Rate: $0.50
   - Status: Available

2. **Create a test booking**:
   - Project_ID: 12345
   - Van_ID: V001
   - Driver_Name: Test Driver
   - Driver_Contact: test@example.com
   - Start_DateTime: Tomorrow at 9:00 AM
   - End_DateTime: Tomorrow at 5:00 PM
   - Status: Requested

3. **Verify validations**:
   - Try creating a booking with Project_ID: 123 (should fail - not 5 digits)
   - Try creating a van with duplicate Van_ID (should fail - unique constraint)
   - Try creating a van with duplicate Registration (should fail - unique constraint)

---

## Troubleshooting

### Common Issues

**Issue**: Cannot create lookup columns
- **Solution**: Ensure the source list (Vans) exists before creating lookup columns in other lists

**Issue**: Unique constraint not working
- **Solution**: Ensure the column is indexed first, then enable "Enforce unique values"

**Issue**: Column validation not working
- **Solution**: Verify the formula syntax is correct and uses square brackets around column names

**Issue**: PowerShell script fails with authentication error
- **Solution**: Run `Connect-PnPOnline -Url <your-site-url> -Interactive` separately to authenticate first

**Issue**: Permissions not applying correctly
- **Solution**: Clear browser cache and sign out/in again. Permissions can take a few minutes to propagate.

### Verification Checklist

Use this checklist to verify your setup is complete:

- [ ] All 8 lists/libraries created (Vans, Van Documents, Bookings, Maintenance, Incidents, Costs, Audit_Trail, Error_Log)
- [ ] All columns added to each list with correct types
- [ ] Unique constraints configured on Van_ID and Registration in Vans list
- [ ] Lookup columns configured correctly (Van_ID in all related lists)
- [ ] Project_ID validation configured in Bookings and Costs lists
- [ ] Versioning enabled on Vans and Bookings lists
- [ ] Attachments enabled on Maintenance and Incidents lists
- [ ] SharePoint groups created (Project Representatives, Fleet Administrators, Finance Managers)
- [ ] List-level permissions configured for Bookings (own items only)
- [ ] Audit_Trail list configured as read-only
- [ ] Test records created successfully
- [ ] Validation rules tested and working

---

## Next Steps

After completing the SharePoint setup:

1. **Create Power Automate Flows** (Task 2):
   - Booking conflict detection flow
   - Booking status transition flow
   - Incident auto-assignment flow
   - Maintenance status update flows
   - Notification flows
   - Audit trail flows

2. **Create Power Apps** (Task 3):
   - Booking Management App
   - Calendar View App
   - Vehicle Profile App
   - Fleet Management App
   - Reporting App

3. **Configure Integration**:
   - Connect Power Apps to SharePoint lists
   - Configure Power Automate triggers
   - Set up Microsoft Teams notifications
   - Configure email notifications

---

## Support and Resources

### Microsoft Documentation
- [SharePoint Lists](https://support.microsoft.com/en-us/office/introduction-to-lists-0a1c3ace-def0-44af-b225-cfa8d92c52d7)
- [PnP PowerShell](https://pnp.github.io/powershell/)
- [Column Validation](https://support.microsoft.com/en-us/office/examples-of-common-formulas-in-sharepoint-lists-d81f5f21-2b4e-45ce-b170-bf7ebf6988b3)

### Project Resources
- Requirements Document: `.kiro/specs/van-booking-fleet-management/requirements.md`
- Design Document: `.kiro/specs/van-booking-fleet-management/design.md`
- Tasks Document: `.kiro/specs/van-booking-fleet-management/tasks.md`

---

## Appendix: PowerShell Script Reference

The automated setup script (`Setup-VBMSSharePointSite.ps1`) performs the following actions:

1. Connects to SharePoint Online using PnP PowerShell
2. Creates all required lists and libraries
3. Adds all columns with correct types and settings
4. Configures unique constraints and indexes
5. Enables versioning where required
6. Enables attachments where required
7. Provides summary of actions taken

**Script Parameters**:
- `-SiteUrl` (Required): The URL of your SharePoint site
- `-SiteTitle` (Optional): The title for the site (default: "Van Booking & Fleet Management System")
- `-AdminEmail` (Optional): Administrator email for notifications

**Example Usage**:
```powershell
.\Setup-VBMSSharePointSite.ps1 -SiteUrl "https://contoso.sharepoint.com/sites/vbms"
```

---

## Document Version

- **Version**: 1.0
- **Last Updated**: 2024
- **Author**: VBMS Implementation Team
- **Status**: Active
